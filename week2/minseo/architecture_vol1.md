# 1장. 사용자 수에 따른 규모 확장성

- 단일 서버 : 웹, 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행됨

### 데이터베이스

- 유저가 늘어서 여러 서버를 두어야 하는 경우, 하나는 `웹/모바일 트래픽 처리 용도`이고, 다른 하나는 `데이터베이스용`이다.
- 데이터 베이스는 관계형 / 비관계형 데이터베이스가 존재하는데, 비관계형 데이터베이스가 바람직한 경우는 다음과 같다.
    - 아주 낮은 응답 지연시간(latency)이 요구됨
    - 다루는 데이터가 비정형(unstructured) 이라 관계형 데이터가 아님
    - 데이터를 직렬화/역직렬화 할 수 있기만 하면 됨
    - 아주 많은 양의 데이터를 저장할 필요가 있음

---

### 수직적 규모 확장 vs. 수평적 규모 확장

- 서버로 유입되는트래픽의 양이 적을 때 ⇒ “수직적 확장”
- 하지만, 수직적 확장은 자동복구 방안 or 다중화 방안을 제시하지 않는다. 서버에 장애가 발생하면 웹사이트/앱은 완전히 중단된다.
- 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장법이 적절
- 웹 서버에 바로 연결될 때 응답 속도가 느려지거나 서버 접속이 불가능해 질 때 부하 분산기 or 로드 밸런서 도입 가능
- 로드밸런서
    
    = 트래픽 부하를 고르게 분산하는 역할 
    
    - 부하 분산 집합에 또 하나의 웹 서버를 추가하고 나면 장애를 자동복구하지 못하는 문제  해소 가능
- 데이터베이스 다중화(데이터 계층)
    - master-slave 관계 설정 → 데이터 원본은 주 서버, 사본은 부 서버에 저장하는 방식
    - master : 쓰기 연산
    - slave : 읽기 연산

✔️ 응답 시간 개선 위해 “캐시”를 붙이고 정적 콘텐츠를 CDN 으로 옮기면 개선할 수 있다.

### 캐시

= 값비싼 연산 결과or자주 참조되는 데이터를 메모리 안에 두고, 요청이 보다 빨리 처리될 수 있도록 하는 저장소

- 애플리케이션의 성능은 ***데이터베이스를 얼마나 자주 호출하느냐***에 따라 좌우된다
- 캐시 계층
    - 캐시 우선 읽기 전략
    - memcached API
- 캐시 사용 시 유의할 점
    - 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어나는 경우
    - **`일관성` :** 데이터 저장소의 원본/캐시 내의 사본이 같은지 여부
        - 저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랜잭션으로 처리되지 않는 경우 이 일관성은 깨질 수 있다.
    - 캐시 서버를 한 대만 두는 경우 해당 서버의 단일장애지점(SPOF)이 되어버릴 가능성 존재
        
        ⇒ 여러 지역에 걸쳐 캐시 서버를 분산시켜야 함
        
    - 캐시 메모리 과할당(overprovision)
    - 데이터 방출 정책 : LRU, LFU, FIFO

### 콘텐츠 전송 네트워크 (CDN)

= 정적 콘텐츠를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크 

- *동적 콘텐츠 캐싱 = 요청 경로, 질의 문자열, 쿠키, 요청 헤더 등의 정보에 기반하여 HTML 페이지를 캐싱*
- 사용자 → 웹사이트 방문 → 사용자에게 가장 가까운 CDN 서버가 정적 컨텐츠를 전달
    
    ⇒ 사용자가 CDN 서버로부터 멂면 멀수록 웹사이트는 천천히 로드됨 
    
- CDN 동작 원리
    1. 이미지 URL을 이용해 image.png에 접근. URL의 도메인은 CDN 서비스 사업자가 제공한 것.
    2. CDN 서버의 캐시에 해당 이미지가 없는 경우 서보는 원본 서버에 요청하여 파일을 가져옴. 
    3. 원본 서버가 파일을 CDN 서버에 반환. HTTP 헤더에는 해당 파일이 얼마나 오래 캐시될 수 있는지를 설명하는 TTL값이 들어가 있음 
    4. CDN 서버는 파일을 캐시, 반환. 이미지는 TTL에 명시된 시간이 끝날때까지 캐시됨
    5. 다른 유저가 같은 이미지에 대한 요청을 CDN 서버에 전송
    6. 만료되지 않은 이미지에 대한 요청은 캐시를 통해 처리됨 

✔️ 정적 콘텐츠는 더 이상 웹 서버를 통해 서비스하지 X, CDN을 통해 제공하여 더 나은 성능을 보장

✔️ 캐시가 데이터베이스 부하를 줄여줌 

![image.png](image.png)

---

### 무상태(stateless) 웹 계층

- 웹 계층을 수평적으로 확장하기 위해서는 **상태 정보(사용자 세션 데이터와 같은)를 웹 계층에서 제거해야 함**
    
    ⇒ 상태 정보는 지속성 저장소에 보관하고 필요할 때 가져오도록 함
    
- ***상태 정보 의존적인 아키텍처***
    - 클라이언트 정보(상태)를 유지하여 요청들 사이에 공유되도록 함
    - 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 한다는 것
        
        → “고정 세션” : 로드 밸런서에 부담 
        
- ***무상태 아키텍처***
    - HTTP 요청은 어떤 웹 서버로도 전달될 수 있고 웹 서버는 상태 정보가 필요할 경우 “공유 저장소”로부터 데이터를 불러옴
    
    ⇒ 상태 정보는 웹 서버로부터 물리적으로 분리되어 있음
    

---

### 데이터 센터

- 두 개의 데이터 센터. 지리적 라우팅(가장 가까운 데이터 센터로 안내됨)
- 다중 데이터센터 아키텍처를 만들기 위해 해결해야하는 기술적 난제
    - 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야 함
    - 데이터 동기화 : 데이터를 여러 데이터 센터에 걸쳐 다중화
    - 테스트와 배포 : 자동화된 배포 도구는 모든 데이터 센터에 동일한 서비스가 설치되도록 하는 데 중요한 역할

✔️ 시스템을 더 큰 규모로 확장하기 위해 **시스템의 컴포넌트를 분리+독립적으로 확장할 수 있도록 해야** 

⇒ `“메시지 큐”` 가 이를 해결할 수 있음 

---

### 메시지 큐

> 메시지의 **무손실**(=메시지 큐에 일단 보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관된다는 특성)을 보장하는 **비동기 통신**을 지원하는 컴포넌트
> 
- 메시지의 버퍼 역할, 비동기적으로 전송
- 메시지 큐 사용 시, 서버간 결합이 느슨해짐 → 안정적 애플리케이션 구성하기 좋음
- 생산자는 소비자 프로세스가 다운되어 있어도 메시지를 발행할 수 있고, 소비자는 생산자 서비스가 가용한 상태가 아니어도 메시지 수신 가능
- (ex.)
    1. *웹 서버가 사진 보정 작업(job)을 메시지 큐에 넣음*
    2. *사진 보정 작업(worker) 프로세스들은 이 작업을 메시지 큐에서 꺼내 비동기적으로 완료*

### 로그, 메트릭, 자동화

- `로그`
    - 에러 로그 모니터링
    - 로그를 단일 서비스로 모아주는 도구 활용 가능
- `메트릭` : 메트릭을 잘 수집하면 사업 현황에 관한 유용한 정보를 얻을 수도 있고, 시스템의 현재 상태를 손쉽게 파악 O
    - 호스트 단위 메트릭, 종합 메트릭, 핵심 비즈니스 메트릭
- `자동화` : 코드가 검증 절차를 자동으로 거치도록 할 수 O

![image.png](image%201.png)

---

### 데이터베이스의 규모 확장

- 수직적 확장 : SPOF로 인한 위험성이 크다
- **수평적 확장(=샤딩)**
    - 샤딩=대규모 데이터베이스를 샤드라고 부르는 작은 단위로 분할
    - 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.
    - `“샤딩 키(=파티션 키)”` 중요 !
        
        → 데이터가 어떻게 분산될 지 정하는 하나 이상의 칼럼으로구성됨 
        
        - 데이터를 고르게 분할 할 수 있도록 샤딩 키를 정해야 함
    - 해결해야 하는 문제
        - 데이터의 재 샤딩(reshading)
            1. 데이터가 너무 많아져서 하나의 샤드로는 더 이상 감당하기 어려울 때
            2. 샤드 간 데이터 분포가 균등하지 못하여 어떤 샤드에 할당된 공간 소모가 다른 샤드에 비해 빨리 진행될 때
            
            → 샤드 키를 계산하는 함수 변경, 데이터를 재배치 해야
            
        - 유명인사 문제
        - 조인과 비정규화
            - 여러 샤드에 걸친 데이터를 조인하기가 힘들어짐
            
            ⇒  데이터베이스를 비정규화 → 하나의 테이블에서 질의가 수행될 수 있도록 함 
            

![image.png](image%202.png)

- 데이터베이스에 대한 부하를 줄이기 위해 RDBMS가 요구되지 않는 기능들은 NoSQL로 이전

---

<aside>
✅

웹 계층은 무상태 계층

모든 계층에 다중화 도입

가능한 한 많은 데이터를 캐시하도록

여러 데이터 센터를 지원

정적 컨텐츠는 CDN을 통해 서비스하도록

데이터 계층은 샤딩을 통해 그 규모를 확장

각 계층은 독립적 서비스로 분할

시스템을 지속적으로 모니터링, 자동화 도구들을 활용

</aside>